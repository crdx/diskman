#!/usr/bin/env ruby
require_relative '../lib/diskman'
require 'docopt'

include Diskman

Params = Struct.new(
    :version,
    :list,
    :write,
    :fdisk,
    :mkfs,
    :file,
    keyword_init: true,
)

class Main
    def initialize(opts)
        @opts = opts
    end

    def self.run(opts)
        new(opts).run
    end

    def params
        @params ||= Params.new(
            version: @opts['--version'],
            list: @opts['--list'],
            write: @opts['write'],
            fdisk: @opts['fdisk'],
            mkfs: @opts['mkfs'],
            file: @opts['<file>'],
        )
    end

    def run
        if params.version
            puts VERSION
            exit
        end

        if params.mkfs
            Command::Mkfs.new.run(list: params.list)
        elsif params.write
            Command::Write.new.run(file: params.file)
        elsif params.fdisk
            Command::Fdisk.new.run
        end
    rescue Interrupt # rubocop:disable Lint/SuppressedException
    end
end

PROGRAM_NAME = File.basename($PROGRAM_NAME)

usage = <<~EOF
    Usage:
        #{PROGRAM_NAME} write <file>
        #{PROGRAM_NAME} fdisk
        #{PROGRAM_NAME} mkfs [--list]
        #{PROGRAM_NAME} ( --version | --help )

    Options:
        -v, --version    Show version
        -h, --help       Show help
EOF

begin
    Main.run(Docopt.docopt(usage))
rescue Docopt::Exit
    puts usage
    exit 2
end
